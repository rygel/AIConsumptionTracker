@page
@model ChartsModel
@{
    ViewData["Title"] = "Charts";
}

<h1 class="page-title">Usage Over Time</h1>

@if (!Model.IsDatabaseAvailable)
{
    <div class="alert alert-warning">
        Database not found. The Agent must run first.
    </div>
}
else
{
    <div class="chart-controls mb-2">
        <select id="timeRange" class="theme-select" style="width: auto;">
            <option value="6">Last 6 hours</option>
            <option value="12">Last 12 hours</option>
            <option value="24" selected>Last 24 hours</option>
            <option value="48">Last 48 hours</option>
            <option value="168">Last 7 days</option>
        </select>
    </div>
    
    <div class="chart-container">
        <canvas id="usageChart"></canvas>
    </div>
    
    @if (Model.ChartData?.Any() != true)
    {
        <div class="alert alert-info">
            No historical data available yet.
        </div>
    }
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const chartData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ChartData ?? new List<AIConsumptionTracker.Web.Services.ChartDataPoint>()));
        
        function initChart(hours) {
            const ctx = document.getElementById('usageChart');
            if (!ctx) return;
            
            // Filter data by time range
            const cutoff = new Date();
            cutoff.setHours(cutoff.getHours() - hours);
            const filtered = chartData.filter(d => new Date(d.Timestamp) >= cutoff);
            
            // Group by provider
            const providers = [...new Set(filtered.map(d => d.ProviderName))];
            const colors = ['#3b82f6', '#22c55e', '#eab308', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'];
            
            const datasets = providers.map((name, i) => {
                const data = filtered
                    .filter(d => d.ProviderName === name)
                    .map(d => ({ x: new Date(d.Timestamp), y: d.UsagePercentage }));
                return {
                    label: name,
                    data: data,
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '20',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 2
                };
            });
            
            new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        x: {
                            type: 'time',
                            time: { displayFormats: { hour: 'HH:mm' } },
                            title: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Usage %' }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15 } },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%`
                            }
                        }
                    }
                }
            });
        }
        
        document.getElementById('timeRange')?.addEventListener('change', e => {
            const hours = parseInt(e.target.value);
            initChart(hours);
        });
        
        // Initialize with default 24 hours
        initChart(24);
    </script>
}
